syntax = "proto3";

package api.product.v1;

option go_package = "product/api/product/v1;v1";
option java_multiple_files = true;
option java_package = "api.product.v1";

import "google/api/annotations.proto";
import "google/protobuf/field_mask.proto";

service ProductService {
  // List products with filters, sorting, pagination.
  // FieldMask query format: mask.paths=name&mask.paths=spec.cpu
  rpc ListProduct (ListProductReq) returns (ListProductReply) {
    option (google.api.http) = { get: "/v1/products" };
  }

  // Create a new product with spec
  rpc CreateProduct (CreateProductReq) returns (CreateProductReply) {
    option (google.api.http) = {
      post: "/v1/products"
      body: "*"
    };
  }

  // Purchase a product (normal purchase, not seckill)
  rpc PurchaseProduct (PurchaseProductReq) returns (PurchaseProductReply) {
    option (google.api.http) = {
      post: "/v1/products/{product_id}/purchase"
      body: "*"
    };
  }
}

// OrderService 订单服务（包含订单关联的资源查询）
service OrderService {
  // Get order by ID
  rpc GetOrder (GetOrderReq) returns (GetOrderReply) {
    option (google.api.http) = { get: "/v1/orders/{order_id}" };
  }

  // Get order resource info (查询订单关联的资源信息)
  rpc GetOrderResource (GetOrderResourceReq) returns (GetOrderResourceReply) {
    option (google.api.http) = { get: "/v1/orders/{order_id}/resource" };
  }

  // List user orders with filters
  rpc ListOrders (ListOrdersReq) returns (ListOrdersReply) {
    option (google.api.http) = { get: "/v1/orders" };
  }
}

message ProductSpec {
  int32 cpu = 1;
  int32 memory = 2;
  int32 gpu = 3;
  string image = 4;
  string config_json = 5;
}

message Product {
  int64 id = 1;
  string name = 2;
  string description = 3;
  int32 status = 4;
  int64 price = 5;
  ProductSpec spec = 6;
}

enum SortBy {
  SORT_BY_UNSPECIFIED = 0;
  SORT_BY_PRICE = 1;
  SORT_BY_CPU = 2;
  SORT_BY_MEMORY = 3;
  SORT_BY_GPU = 4;
}

enum SortOrder {
  SORT_ORDER_UNSPECIFIED = 0;
  ASC = 1;
  DESC = 2;
}

message ListProductReq {
  int64 min_price = 1;
  int64 max_price = 2;
  SortBy sort_by = 3;
  SortOrder sort_order = 4;
  uint32 page = 5;
  uint32 page_size = 6;
  google.protobuf.FieldMask mask = 7;
}

message ListProductReply {
  repeated Product products = 1;
  uint32 page = 2;
  uint32 page_size = 3;
  int64 total = 4;
}

message CreateProductReq {
  string name = 1;
  string description = 2;
  int64 price = 3;
  ProductSpec spec = 4;
}

message CreateProductReply {
  Product product = 1;
}

message PurchaseProductReq {
  int64 product_id = 1;
  string user_id = 2;
}

message PurchaseProductReply {
  int64 order_id = 1;
  int64 resource_id = 2; // 资源ID（由资源域管理）
  string status = 3;
}

// Order 订单信息
message Order {
  int64 order_id = 1;
  string user_id = 2;
  int64 product_id = 3;
  int64 req_id = 4;
  int64 amount = 5;
  int64 resource_id = 6; // 资源ID（支付后填充）
  string status = 7; // PENDING, PAID, COMPLETED, CANCELLED
  int64 created_at = 8;
  int64 paid_at = 9;
  int64 completed_at = 10;
}

// OrderResource 订单关联的资源信息
message OrderResource {
  int64 resource_id = 1; // 资源ID
  int64 order_id = 2;    // 订单ID
  string user_id = 3;    // 用户ID
  int64 product_id = 4;  // 商品ID
  string product_name = 5; // 商品名称
  ProductSpec spec = 6;    // 资源规格
  string status = 7;       // 资源状态（CREATING, RUNNING, STOPPED, DELETED）
  int64 created_at = 8;    // 创建时间
}

message GetOrderReq {
  int64 order_id = 1;
}

message GetOrderReply {
  Order order = 1;
}

message GetOrderResourceReq {
  int64 order_id = 1;
}

message GetOrderResourceReply {
  OrderResource resource = 1;
}

message ListOrdersReq {
  string user_id = 1;
  string status = 2; // 订单状态过滤
  uint32 page = 3;
  uint32 page_size = 4;
}

message ListOrdersReply {
  repeated OrderResource resources = 1; // 返回订单关联的资源信息
  uint32 page = 2;
  uint32 page_size = 3;
  int64 total = 4;
}
