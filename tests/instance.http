### 实例服务 API 测试（gRPC）
### 基础配置
@grpcHost = localhost:9002

### 注意：实例的实际管理由资源域（Resource Domain）负责
### 商品域只负责：
### 1. 生成 InstanceID
### 2. 发送 MQ 消息给资源域
### 3. 更新订单的 instance_id 字段
### 以下为预期的查询接口（待在 proto 中定义）

###############################################
### gRPC 接口测试
###############################################

### 1. 获取实例详情
GRPC {{grpcHost}}/api.product.v1.InstanceService/GetInstance

{
  "instance_id": 4233102175792402416
}

### 2. 获取用户实例列表
GRPC {{grpcHost}}/api.product.v1.InstanceService/ListInstances

{
  "user_id": "37c27669-00e8-44ca-80d1-b8429428bec4",
  "page": 1,
  "page_size": 10
}

### 3. 获取实例列表（按状态过滤）
GRPC {{grpcHost}}/api.product.v1.InstanceService/ListInstances

{
  "status": "PAID",
  "page": 1,
  "page_size": 10
}

### 4. 获取实例列表（按状态过滤 - CREATING）
GRPC {{grpcHost}}/api.product.v1.InstanceService/ListInstances

{
  "status": "CREATING",
  "page": 1,
  "page_size": 10
}

### 5. 通过订单ID查询实例
GRPC {{grpcHost}}/api.product.v1.InstanceService/GetInstanceByOrder

{
  "order_id": 6859826658465918960
}

### 6. 获取所有实例（不过滤）
GRPC {{grpcHost}}/api.product.v1.InstanceService/ListInstances

{
  "page": 1,
  "page_size": 20
}

###############################################
### 数据库查询测试（使用 psql）
###############################################

### 查询订单关联的实例ID
# psql -h localhost -p 5433 -U postgres -d product
# 
# SELECT 
#   o.id as order_id,
#   o.user_id,
#   o.product_id,
#   o.instance_id,
#   o.status as order_status,
#   o.source,
#   o.created_at
# FROM orders o
# WHERE o.instance_id IS NOT NULL
# ORDER BY o.created_at DESC
# LIMIT 10;

### 查询实例创建日志
# SELECT 
#   il.id,
#   il.instance_id,
#   il.user_id,
#   il.product_id,
#   il.source,
#   il.source_id,
#   il.status,
#   il.created_at,
#   il.updated_at
# FROM instance_logs il
# ORDER BY il.created_at DESC
# LIMIT 10;

### 关联查询：订单 + 商品 + 实例日志
# SELECT 
#   o.id as order_id,
#   o.user_id,
#   p.name as product_name,
#   o.amount,
#   o.instance_id,
#   il.status as instance_status,
#   o.created_at as order_created_at,
#   il.created_at as instance_created_at
# FROM orders o
# JOIN products p ON o.product_id = p.id
# LEFT JOIN instance_logs il ON o.instance_id = il.instance_id
# WHERE o.instance_id IS NOT NULL
# ORDER BY o.created_at DESC
# LIMIT 10;

### 查询实例创建失败的记录
# SELECT 
#   il.instance_id,
#   il.user_id,
#   il.product_id,
#   il.status,
#   il.created_at
# FROM instance_logs il
# WHERE il.status != 'COMPLETED'
# ORDER BY il.created_at DESC;

### 统计实例创建情况
# SELECT 
#   il.source,
#   il.status,
#   COUNT(*) as count
# FROM instance_logs il
# GROUP BY il.source, il.status;

###############################################
### RabbitMQ 测试
###############################################

### 查看队列消息（需要安装 rabbitmqadmin）
# rabbitmqadmin -H localhost -P 15672 -u guest -p guest list queues

### 查看队列详情
# rabbitmqadmin -H localhost -P 15672 -u guest -p guest get queue=resource.instance.created count=10

### 发布测试消息（模拟商品域发送）
# rabbitmqadmin -H localhost -P 15672 -u guest -p guest publish \
#   exchange=resource.events \
#   routing_key=instance.created \
#   payload='{"instance_id":1234567890,"user_id":"user123","name":"测试实例","cpu":2,"memory":4096,"gpu":0,"image":"ubuntu:22.04","config_json":"{}"}'

### 使用 Python 发送 MQ 消息
# python3 << EOF
# import pika
# import json
# 
# connection = pika.BlockingConnection(pika.URLParameters('amqp://guest:guest@localhost:5673/'))
# channel = connection.channel()
# 
# message = {
#     "instance_id": 1234567890,
#     "user_id": "user123",
#     "name": "测试实例",
#     "cpu": 2,
#     "memory": 4096,
#     "gpu": 0,
#     "image": "ubuntu:22.04",
#     "config_json": "{}"
# }
# 
# channel.basic_publish(
#     exchange='resource.events',
#     routing_key='instance.created',
#     body=json.dumps(message)
# )
# 
# print("消息已发送")
# connection.close()
# EOF
